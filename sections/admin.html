<h2>Admin Section</h2>
<div id="admin-login">
  <input type="password" id="admin-pass" placeholder="Enter admin password">
  <button onclick="loginAdmin()">Login</button>
</div>
<div id="admin-forms" style="display:none;">

  <!-- Roster Management -->
  <fieldset>
    <legend>Edit Roster</legend>
    <form onsubmit="event.preventDefault(); addPlayer();">
      <label>Name: <input type="text" id="player-name" required></label>
      <label>Position: <input type="text" id="player-pos" required></label>
      <label>Bio: <textarea id="player-bio"></textarea></label>
      <label>Image URL: <input type="url" id="player-img"></label>
      <button type="submit">Add Player</button>
    </form>
    <div>
      <h4>Current Players</h4>
      <ul id="admin-roster-list"></ul>
    </div>
  </fieldset>

  <!-- Schedule Management -->
  <fieldset>
    <legend>Edit Schedule</legend>
    <form onsubmit="event.preventDefault(); addGame();">
      <label>Date: <input type="date" id="game-date" required></label>
      <label>Opponent: <input type="text" id="game-opp" required></label>
      <label>Location: <input type="text" id="game-loc"></label>
      <label>Result: <input type="text" id="game-res"></label>
      <button type="submit">Add Game</button>
    </form>
    <div>
      <h4>Current Schedule</h4>
      <ul id="admin-schedule-list"></ul>
    </div>
  </fieldset>

  <!-- Stats Management -->
  <fieldset>
    <legend>Edit Stats</legend>
    <form onsubmit="event.preventDefault(); updateStats();">
      <label>Player Name: <input type="text" id="stats-player" required></label>
      <label>Points: <input type="number" id="stats-pts"></label>
      <label>Rebounds: <input type="number" id="stats-reb"></label>
      <label>Assists: <input type="number" id="stats-ast"></label>
      <button type="submit">Update Stats</button>
    </form>
    <div>
      <h4>Current Stats</h4>
      <ul id="admin-stats-list"></ul>
    </div>
  </fieldset>

  <!-- Gallery Management -->
  <fieldset>
    <legend>Manage Gallery</legend>
    <form onsubmit="event.preventDefault(); addImage();">
      <label>Date: <input type="date" id="gallery-date" required></label>
      <label>Full Image URL: <input type="url" id="gallery-img" required></label>
      <button type="submit">Upload Image</button>
    </form>
    <div>
      <h4>Gallery (Grouped by Date)</h4>
      <div id="admin-gallery-date-groups"></div>
    </div>
  </fieldset>

  <!-- Export Data Button -->
  <button onclick="exportData()">Export Data as JSON</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Show admin data after login
  function refreshAdminLists() {
    // Roster
    let rosterList = document.getElementById('admin-roster-list');
    rosterList.innerHTML = '';
    let players = JSON.parse(localStorage.getItem('players')) || [];
    players.forEach((player, idx) => {
      let li = document.createElement('li');
      li.innerHTML = `<strong>${player.name}</strong> (${player.pos})
        <button onclick="removePlayer(${idx})">Delete</button>`;
      rosterList.appendChild(li);
    });

    // Schedule
    let scheduleList = document.getElementById('admin-schedule-list');
    scheduleList.innerHTML = '';
    let games = JSON.parse(localStorage.getItem('games')) || [];
    games.forEach((game, idx) => {
      let li = document.createElement('li');
      li.innerHTML = `<strong>${game.date}</strong>: ${game.opp} at ${game.loc} (${game.res || 'No result'})
        <button onclick="removeGame(${idx})">Delete</button>`;
      scheduleList.appendChild(li);
    });

    // Stats
    let statsList = document.getElementById('admin-stats-list');
    statsList.innerHTML = '';
    let stats = JSON.parse(localStorage.getItem('stats')) || {};
    Object.keys(stats).forEach((player) => {
      let s = stats[player];
      let li = document.createElement('li');
      li.innerHTML = `<strong>${player}</strong>: ${s.pts || 0} pts, ${s.reb || 0} reb, ${s.ast || 0} ast
        <button onclick="removeStats('${player}')">Delete</button>`;
      statsList.appendChild(li);
    });

    // Gallery (grouped by date)
    let galleryGroupDiv = document.getElementById('admin-gallery-date-groups');
    galleryGroupDiv.innerHTML = '';
    let gallery = JSON.parse(localStorage.getItem('gallery')) || [];
    // gallery: [{date: "2025-09-11", url: "..."}, ...]
    let grouped = {};
    gallery.forEach(imgObj => {
      let date = imgObj.date || "No Date";
      if (!grouped[date]) grouped[date] = [];
      grouped[date].push(imgObj.url);
    });
    Object.keys(grouped).sort().reverse().forEach(date => {
      let groupDiv = document.createElement('div');
      groupDiv.innerHTML = `<h5>${date}</h5>`;
      grouped[date].forEach((imgUrl, idx) => {
        let imgDiv = document.createElement('div');
        imgDiv.style.display = "inline-block";
        imgDiv.style.margin = "5px";
        imgDiv.innerHTML = `
          <img src="${imgUrl}" alt="Gallery Image" style="max-width:200px;max-height:150px;">
          <br>
          <button onclick="removeGalleryImage('${date}', ${idx})">Delete</button>
        `;
        groupDiv.appendChild(imgDiv);
      });
      galleryGroupDiv.appendChild(groupDiv);
    });
  }

  // Add remove functions to window
  window.removePlayer = function(idx) {
    let players = JSON.parse(localStorage.getItem('players')) || [];
    players.splice(idx, 1);
    localStorage.setItem('players', JSON.stringify(players));
    refreshAdminLists();
  };
  window.removeGame = function(idx) {
    let games = JSON.parse(localStorage.getItem('games')) || [];
    games.splice(idx, 1);
    localStorage.setItem('games', JSON.stringify(games));
    refreshAdminLists();
  };
  window.removeStats = function(player) {
    let stats = JSON.parse(localStorage.getItem('stats')) || {};
    delete stats[player];
    localStorage.setItem('stats', JSON.stringify(stats));
    refreshAdminLists();
  };
  window.removeGalleryImage = function(date, idx) {
    let gallery = JSON.parse(localStorage.getItem('gallery')) || [];
    let groupIdx = gallery.findIndex(imgObj => imgObj.date === date);
    // Remove by matching date and idx within group
    let count = 0;
    for(let i=0; i<gallery.length; i++) {
      if(gallery[i].date === date) {
        if(count === idx) {
          gallery.splice(i, 1);
          break;
        }
        count++;
      }
    }
    localStorage.setItem('gallery', JSON.stringify(gallery));
    refreshAdminLists();
  };

  // Patch addImage to use date
  window.addImage = function() {
    let img = document.getElementById('gallery-img').value;
    let date = document.getElementById('gallery-date').value;
    if (img && date) {
      let gallery = JSON.parse(localStorage.getItem('gallery')) || [];
      gallery.push({date: date, url: img});
      localStorage.setItem('gallery', JSON.stringify(gallery));
      document.getElementById('gallery-img').value = '';
      document.getElementById('gallery-date').value = '';
      refreshAdminLists();
    }
  };

  // Patch addPlayer, addGame, updateStats to refresh lists if called from admin
  let origAddPlayer = window.addPlayer;
  window.addPlayer = function() {
    origAddPlayer();
    refreshAdminLists();
  };
  let origAddGame = window.addGame;
  window.addGame = function() {
    origAddGame();
    refreshAdminLists();
  };
  let origUpdateStats = window.updateStats;
  window.updateStats = function() {
    origUpdateStats();
    refreshAdminLists();
  };

  // Patch loginAdmin to refresh lists after login
  let origLoginAdmin = window.loginAdmin;
  window.loginAdmin = function() {
    origLoginAdmin();
    setTimeout(refreshAdminLists, 100); // Wait for forms to show
  };

  // If already logged in, show lists
  if(document.getElementById('admin-forms').style.display !== 'none') {
    refreshAdminLists();
  }
});
</script>